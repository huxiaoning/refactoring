# 4.1 自测试代码的价值

<br>

如果认真观察程序员把最多时间耗在哪里，你就会发现，编写代码其实只占非常小的一部分。

有些时间用，决定下一步干什么，另一些时间花在设计上，最多的时间则是用来调试，我敢肯定每一位读者都还记得自己花在调试上的无数个小时，无数次通宵达旦。

每个程序员都能讲出花一整天（甚至更多）时间只为找出一个小问题的故事。

修复错误通常是比较快的，但找出错误却是噩梦一场。

当你修好一个错误，总是会有另一个错误出现，而且肯定要很久以后才会注意到它。

那时你又要花上大把时间去寻找它。

<br>

我走上“自测试代码”这条路，肇因于1992年OOPSLA大会上的一次演讲。

会场上有人（我记得好像是Dave Thomas）说： “类应该包含它们自己的测试代码。”

这激发了我的灵感，让我想到一种组织测试的好方法。

我这样解释它：每个类都应该有一个测试函数，并以它来测试自己这个类。

<br>

那时候我还着迷于增量式开发，所以尝试在结束每次增量时，为每个类添加测试。

当时我开发的项目很小，所以我们大约每周增量一次。

执行测试相当简单，但尽管如此，做这些测试还是很烦人，因为每个测试都把结果输出到控制台，而我必须逐一检查它们。

我是个很懒的人，情愿当下努力工作以免除日后的工作。

我意识到其实完全不必自己盯着屏幕检验测试所得信息是否正确，大可让计算机来帮我做这件事。

我需要做的就是把我所期望的输出放进测试代码中，然后做一个比较就行了。

于是我可以舒服地执行每个类的测试函数，如果一切都没问题，屏幕上就只出现一个OK。

现在，这些类都能够“自我测试”了。

<br>

> 确保所有测试都完全自动化，让它们检查自己的测试结果。

<br>

此后再进行测试就简单多了，和编译一样简单。

于是我开始在每次编译之后都进行测试。

很快我发现自己的生产性能大大提高。

我意识到那是因为我没有花太多时间去调试。

如果我不小心引入一个可被现有测试捕捉到的错误，那么只要执行测试，它就会向我报告这个错误。

由于测试本来是可以正常运行的，所以我知道这个错误必定是在前一次执行测试后引入的。

由于我频繁地进行测试，每次测试都在不久之前，因此我知道错误的源头就是我刚刚写下的代码。

而由于我对那段代码记忆犹新，份量也很小，所以就能轻松找到错误。

从前需要一小时甚至更多时间才能找到的错误，现在最多只需两分钟就找到了。

之所以能够拥有如此强大的侦错能力，不仅仅因为我构筑的类能够自我测试，也因为我频繁地运行它们。

<br>

注意到这一点后，我对测试的积极性更高了。

我不再等待每次增量结束，只要写好一点功能，就立即添加测试。

每天我都会添加一些新功能，同时也添加相应的测试。

那些日子里，我很少花一分钟以上的时间在调试上面。

<br>

> 一套测试就是一个强大的bug侦测器，能够大大缩减查找bug所需要的时间。

<br>

当然，说服别人也这么做并不容易。

编写测试程序，意味要写很多额外代码。

除非你确切体验到这种方法对编程速度的提升，否则自我测试就显不出它的意义。

很多人根本没学过如何编写测试程序，甚至根本没考虑过测试，这对于编写自我测试代码也很不利。

如果需要手动运行测试，那更是令人烦闷；但如果可以自动运行，编写测试代码就真的很有趣。

<br>

实际上，撰写测试代码的最有用时机是在开始编程之前。

当你需要添加特性的时候，先写相应测试代码。

听起来离经叛道，其实不然。

编写测试代码其实就是在问自己：添加这个功能需要做些什么。

编写测试代码还能使你把注意力集中于接口而非实现（这永远是件好事），

预先写好的测试代码也为你的工作安上一个明确的结束标志：一旦测试代码正常运行，工作就可以结束了。

<br>

频繁进行测试是极限编程[Beck， XP]的重要一环。

极限编程一词容易让人联想起那些编码飞快、自由散漫的黑客，实际上极限编程者都是十分专注的测试者。

他们希望尽可能快速开发软件，而且也知道测试能让他们尽可能快速地前进。

<br>

大道理先放在一边。

尽管我相信每个人都可以从编写自我测试代码中受益，但这并不是本书重点。

本书谈的是重构，而重构需要测试。

如果你想重构，就必须编写测试代码。

本章将教你用Java编写测试代码的起步知识。

这不是一本专讲测试的书，所以我不想讲得太仔细。

但我发现，少许测试就足以带来惊人的利益。

<br>

和本书其他内容一样，我以实例来介绍测试手法。

开发软件的时候，我一边撰写代码，一边撰写测试代码。

但是当我和他人并肩重构时，往往得面对许多无法自我测试的代码。

所以重构之前我们首先必须改造这些代码，使其能够自我测试。

<br>

Java之中的测试惯用手法是testing main，意思是每个类都应该有一个用于测试的main（）。

这是一个合理的习惯（尽管并不那么值得称许），但可能不好操控。

这种做法的问题是很难轻松运行多个测试。

另一种做法是：建立一个独立类用于测试，并在一个框架中运行它，使测试工作更轻松。

<br>

