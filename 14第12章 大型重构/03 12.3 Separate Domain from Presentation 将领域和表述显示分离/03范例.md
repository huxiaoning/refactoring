# 范例

<br>

下面是一个商品订购程序。其`GUI`如图12-7所示，其展现类与图12-8所示的关系数据库互动。

<br>

所有行为(包括`GUI`和定单处理)都由`OrderWindow`类处理。

<br>

首先建立一个`Order`类表示“定单”。

然后把`Order`和`OrderWindow`联系起来， 如图12-9。

由于窗口中有一个用以显示定单的表格，所以我们还得建立一个`OrderLine`，用以表示表格中的每一行。

<br>

我们将从窗口这边而不是从数据库那边开始重构。

当然，一开始就把领域模型建立在数据库基础上，也是一种合理策略，但我们最大的风险源于展现逻辑和领域逻辑之间的混淆，因此我们首先基于窗口将这些分离出来，然后再考虑对其他地方进行重构。

<br>

面对这一类程序，在窗口中寻找内嵌的`SQL`(结构化查询语言)语句，会对你有所帮助，因为`SQL`语句获取的数据一定是领域数据。

![image-20211002135127431](https://raw.githubusercontent.com/huxiaoning/img/master/image-20211002135127431.png)

最容易处理的领域数据就是那些不直接显示于`GUI`者。

本例数据库的`Customers`表中有一个`codes`字段，它并不直接显示于`GUI`，而是被转换为一个更容易被人理解的短语之后再显示。

程序中以简单类型(例如`String`)保存这个字段值，而非将其放在`AWT`组件中。

我们可以安全地使用`Move Field (146)`将这个字段移到领域类。

<br>

对于其他字段，我们就没有这么幸运了，因为它们内含`AWT`组件，既显示于窗口，也被领域对象使用。

面对这些字段，我们需要使用`Duplicate Observed Data (189)`，把一个领域字段放进`Order`类，同时把一个相应的`AWT`字段放进`OrderWindow`类。

<br>

这是一个缓慢的过程，但最终我们还是可以把所有领域逻辑字段都搬到领域类。

进行这一步骤时，你可以试着把所有`SQL`调用都移到领域类，这样你就是同时移动了数据库逻辑和领域数据。

最后，你可以在`OrderWindow`中移除`import java.sql`之类的语句，这就表示我们的重构告一段落了。

在此阶段中你可能需要大量运用`Extract Method (110)`和`Move Method (142)`。

![image-20211002135640786](https://raw.githubusercontent.com/huxiaoning/img/master/image-20211002135640786.png)

现在，我们拥有的3个类，如图12-10所示，它们离“组织良好”还有很大的距离。

不过这个模型的确已经很好地分离了展现逻辑和领域逻辑。

本项重构的进行过程中，你必须时刻留心风险来自何方。

如果“展现逻辑和领域逻辑混淆”是最大风险，那么就先把它们完全分开，然后才做其他工作；

如果其他方面的事情(例如产品定价策略)更重要，那么就先把那一部分的逻辑从窗口提炼出来，并围绕着这个高风险部分进行重构，为它建立合适的结构。

反正领域逻辑早晚都必须从窗口移出，如果你在处理高风险部分的重构时会遗留某些逻辑于窗口之中，没关系，你可以稍后再来收拾它。

![image-20211002140033327](https://raw.githubusercontent.com/huxiaoning/img/master/image-20211002140033327.png)



![image-20211002140050026](https://raw.githubusercontent.com/huxiaoning/img/master/image-20211002140050026.png)

<br>

